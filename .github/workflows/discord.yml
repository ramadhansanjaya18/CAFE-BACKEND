name: Discord Smart Notification

on:
  push:
    branches:
      - main
      - develop
      - feature/**
  pull_request:
    types: [opened, closed]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Smart Discord Notification
        run: |
          REPO="${{ github.repository }}"
          AUTHOR="${{ github.actor }}"
          EVENT="${{ github.event_name }}"
          BRANCH="${{ github.ref_name }}"
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          # Default values
          COLOR=3447003
          TITLE="ðŸš€ New Push"
          DESCRIPTION="${{ github.event.head_commit.message }}"
          URL="${{ github.event.head_commit.url }}"

          # If push to main â†’ warning red
          if [ "$BRANCH" = "main" ] && [ "$EVENT" = "push" ]; then
            COLOR=15158332
            TITLE="ðŸš¨ PUSH TO MAIN"
          fi

          # Pull Request opened
          if [ "$EVENT" = "pull_request" ] && [ "${{ github.event.action }}" = "opened" ]; then
            COLOR=15844367
            TITLE="ðŸŸ¡ Pull Request Opened"
            DESCRIPTION="${{ github.event.pull_request.title }}"
            URL="${{ github.event.pull_request.html_url }}"
          fi

          # Pull Request merged
          if [ "$EVENT" = "pull_request" ] && [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            COLOR=3066993
            TITLE="ðŸŸ¢ Pull Request Merged"
            DESCRIPTION="${{ github.event.pull_request.title }}"
            URL="${{ github.event.pull_request.html_url }}"
          fi

          curl -H "Content-Type: application/json" \
          -X POST \
          -d "{
            \"embeds\": [{
              \"title\": \"${TITLE}\",
              \"description\": \"**${DESCRIPTION}**\",
              \"color\": ${COLOR},
              \"fields\": [
                {\"name\": \"ðŸ“¦ Repository\", \"value\": \"${REPO}\", \"inline\": true},
                {\"name\": \"ðŸ‘¤ Author\", \"value\": \"${AUTHOR}\", \"inline\": true},
                {\"name\": \"ðŸŒ¿ Branch\", \"value\": \"${BRANCH}\", \"inline\": true}
              ],
              \"url\": \"${URL}\",
              \"footer\": {
                \"text\": \"CoffeeJob Dev Team â€¢ Automated DevOps\"
              },
              \"timestamp\": \"${TIMESTAMP}\"
            }]
          }" \
          ${{ secrets.DISCORD_WEBHOOK }}
